<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ù–∞–ª–æ–≥–æ–≤ –†–§ 2025/2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #111827;
            --text-light: #6b7280;
            --bg-body: #f3f4f6;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            min-height: 100vh;
            color: var(--text-main);
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1280px;
            margin: 30px auto;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            border: 1px solid #e5e7eb;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            background: #ffffff;
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }

        header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--text-main);
            font-weight: 800;
        }

        header p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 1.1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .container {
                margin: 15px auto;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 0;
            }

            .container {
                margin: 0;
                border: none;
                border-radius: 0;
                box-shadow: none;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .app-container {
                padding: 15px;
                gap: 20px;
            }

            .card,
            .results-section {
                padding: 15px;
                border-radius: 16px;
            }

            .tax-regime-selector {
                grid-template-columns: 1fr;
            }

            .regime-option {
                min-height: 50px;
                flex-direction: row;
                align-items: center;
                justify-content: flex-start;
                gap: 10px;
                text-align: left;
                padding: 12px 15px;
            }

            .regime-option h3 {
                margin-bottom: 0;
                font-size: 0.95rem;
            }

            .regime-option p {
                margin-top: 0;
                margin-left: auto;
            }

            .row-2-col {
                grid-template-columns: 1fr !important;
            }

            .total-amount {
                font-size: 1.7rem;
            }

            .comparison-table th,
            .comparison-table td {
                padding: 8px 5px;
                font-size: 0.8rem;
            }

            .badge {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
        }

        .row-2-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section-title {
            color: var(--text-main);
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Interactive Elements */
        .card {
            background: #f9fafb;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        /* Year Toggle */
        .year-toggle-container {
            display: flex;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .year-btn {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .year-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* Type Toggles */
        .entity-type-switcher {
            display: flex;
            background: rgba(255, 255, 255, 0.5);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .entity-toggle {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .entity-toggle.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Regime Grid */
        .tax-regime-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .regime-option {
            background: white;
            padding: 10px;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 60px;
        }

        .regime-option:hover {
            border-color: rgba(79, 70, 229, 0.3);
            transform: translateY(-2px);
        }

        .regime-option.active {
            border-color: var(--primary);
            background: #eef2ff;
        }

        .regime-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
            pointer-events: none;
        }

        .regime-option.error {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .regime-option h3 {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .regime-option p {
            font-size: 0.75rem;
            color: var(--text-light);
            line-height: 1.2;
            margin-top: 2px;
        }

        /* Inputs */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-main);
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input,
        .input-wrapper select {
            width: 100%;
            padding: 10px 14px;
            padding-right: 30px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.2s;
        }

        .input-wrapper::after {
            content: '‚ÇΩ';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }

        .input-wrapper.no-currency::after {
            content: none;
        }

        .input-wrapper input:focus,
        .input-wrapper select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Warning Box */
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px dashed var(--warning);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .warning-title {
            font-weight: 700;
            font-size: 0.85rem;
            color: #b45309;
            margin-bottom: 4px;
        }

        .warning-text {
            font-size: 0.8rem;
            color: #d97706;
        }

        /* Results */
        .results-section {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .total-card {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.2);
        }

        .total-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .total-amount {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1.1;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        .breakdown-row:last-child {
            border-bottom: none;
        }

        .breakdown-value {
            font-weight: 600;
        }

        /* Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .comparison-table th {
            text-align: left;
            padding: 10px;
            color: var(--text-light);
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }

        .comparison-table td {
            padding: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .row-best {
            background: #ecfdf5;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            vertical-align: middle;
        }

        .badge-success {
            background: #d1fae5;
            color: #059669;
        }

        .badge-purple {
            background: #f3e8ff;
            color: #7e22ce;
        }

        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-calc {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }

        .btn-calc:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .insight-info {
            padding: 15px;
            background: white;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid var(--primary);
            display: none;
        }

        .insight-header {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 5px;
        }

        .insight-text {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        .startup-cost-badge {
            display: inline-block;
            font-size: 0.75rem;
            color: #4b5563;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>–ù–∞–ª–æ–≥–æ–≤—ã–π –ù–∞–≤–∏–≥–∞—Ç–æ—Ä</h1>
            <p>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π 2025 (—Ç–µ–∫—É—â–∏–µ) –∏ 2026 (—Ä–µ—Ñ–æ—Ä–º–∞)</p>
        </header>

        <div class="app-container">
            <div class="input-section">
                <!-- Year Selector -->
                <div class="year-toggle-container">
                    <div class="year-btn active" id="year2025" onclick="UI.setYear(2025)">2025 (–°–µ–π—á–∞—Å)</div>
                    <div class="year-btn" id="year2026" onclick="UI.setYear(2026)">2026 (–†–µ—Ñ–æ—Ä–º–∞)</div>
                </div>

                <!-- Entity Type -->
                <div class="entity-type-switcher">
                    <div class="entity-toggle active" id="typeIP" onclick="UI.setEntityType('ip')">–ò–ü</div>
                    <div class="entity-toggle" id="typeOOO" onclick="UI.setEntityType('ooo')">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</div>

                </div>

                <div class="card">
                    <div id="startupCostDisplay" class="startup-cost-badge">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: 800 ‚ÇΩ</div>

                    <label class="section-title" style="font-size:1rem; margin-bottom:10px;">–†–µ–∂–∏–º
                        –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è</label>
                    <div class="tax-regime-selector" id="regimeSelector">
                        <div class="regime-option active" data-regime="usn_income" id="optUsn6">
                            <h3>–£–°–ù 6%</h3>
                            <p>"–î–æ—Ö–æ–¥—ã"</p>
                        </div>
                        <div class="regime-option" data-regime="usn_income_expenses" id="optUsn15">
                            <h3>–£–°–ù 15%</h3>
                            <p>"–î - –†"</p>
                        </div>
                        <div class="regime-option" data-regime="osno">
                            <h3>–û–°–ù–û</h3>
                        </div>
                        <div class="regime-option" data-regime="patent" id="optPatent">
                            <h3>–ü–∞—Ç–µ–Ω—Ç</h3>
                        </div>
                        <div class="regime-option" data-regime="eshn" id="optEshn">
                            <h3>–ï–°–•–ù</h3>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>–ì–æ–¥–æ–≤–æ–π –¥–æ—Ö–æ–¥</label>
                        <div class="input-wrapper"><input type="text" id="annualIncome" value="15 000 000"></div>
                    </div>

                    <!-- USN VAT Warning -->
                    <div class="warning-box" id="usnVatBox">
                        <div class="warning-title">‚ö†Ô∏è –ù–î–° –Ω–∞ –£–°–ù (<span id="usnVatThresholdDisplay">60</span> –º–ª–Ω+)
                        </div>
                        <div class="warning-text">–í–∞—à –¥–æ—Ö–æ–¥ –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç. –í—ã –ø–ª–∞—Ç–∏—Ç–µ –ù–î–°.</div>
                        <div style="margin-top:8px; display:flex; gap:10px; font-size:0.85rem;">
                            <label><input type="radio" name="usnVatType" value="special" checked> –°–ø–µ—Ü. —Å—Ç–∞–≤–∫–∞ (<span
                                    id="vatSpecialRate">5%</span>)</label>
                            <label><input type="radio" name="usnVatType" value="standard"> 20/22% (–û–±—â–∞—è)</label>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>–ì–æ–¥–æ–≤—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</label>
                        <div class="input-wrapper"><input type="text" id="annualExpenses" value="8 000 000"></div>
                    </div>

                    <div class="input-group">
                        <label>–†–µ–≥–∏–æ–Ω</label>
                        <div class="input-wrapper no-currency">
                            <select id="region">
                                <option value="moscow">–ú–æ—Å–∫–≤–∞</option>
                                <option value="spb">–°. –ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                                <option value="other">–î—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω (–†–§)</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>–í–∏–¥ –±–∏–∑–Ω–µ—Å–∞</label>
                        <div class="input-wrapper no-currency">
                            <select id="businessType">
                                <option value="services">–£—Å–ª—É–≥–∏</option>
                                <option value="retail">–¢–æ—Ä–≥–æ–≤–ª—è (–ú–∞–≥–∞–∑–∏–Ω/–°–µ—Ç—å)</option>
                                <option value="production">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</option>
                                <option value="it">IT-–∫–æ–º–ø–∞–Ω–∏—è</option>
                                <option value="science">–ù–∞—É–∫–∞/–°–æ—Ü.—Å—Ñ–µ—Ä–∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group" id="tradeLevyArg" style="display:none;">
                        <label>–¢–æ—Ä–≥–æ–≤—ã–π —Å–±–æ—Ä (–≥–æ–¥)</label>
                        <div class="input-wrapper"><input type="text" id="tradeLevy" value="0"></div>
                    </div>

                    <div class="row-2-col">
                        <div class="input-group">
                            <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</label>
                            <div class="input-wrapper no-currency"><input type="number" id="employees" value="3"></div>
                        </div>
                        <div class="input-group">
                            <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ (–º–µ—Å.)</label>
                            <div class="input-wrapper"><input type="text" id="avgSalary" value="70 000"></div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;" class="row-2-col">
                        <div class="input-group">
                            <label>–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (–ö–∞–¥–∞—Å—Ç—Ä)</label>
                            <div class="input-wrapper"><input type="text" id="propertyValue" value="0"></div>
                        </div>
                        <div class="input-group">
                            <label>–ó–µ–º–ª—è (–ö–∞–¥–∞—Å—Ç—Ä)</label>
                            <div class="input-wrapper"><input type="text" id="landValue" value="0"></div>
                        </div>
                    </div>

                    <div class="input-group" id="smeBox">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="isSme" checked style="width:auto; margin-right:8px;">
                            –°—É–±—ä–µ–∫—Ç –ú–°–ü
                        </label>
                        <div id="smeBenefitNote" style="font-size:0.75rem; color:var(--success); margin-left:24px;">
                        </div>
                    </div>

                    <div class="input-group" id="ipNewBox">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="isNewIp" style="width:auto; margin-right:8px;">
                            –ö–∞–Ω–∏–∫—É–ª—ã (–ù–æ–≤—ã–π –ò–ü)
                        </label>
                    </div>

                    <div class="input-group" id="partnershipBox">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="isPartnership" style="width:auto; margin-right:8px;">
                            –£—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∏—â–µ—Å—Ç–≤–∞ / –î–£
                        </label>
                    </div>

                    <button class="btn-calc" onclick="UI.update()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                </div>
            </div>

            <div class="results-section">
                <h2 class="section-title">–ò—Ç–æ–≥–∏ <span id="resYearDisplay"
                        style="color:var(--primary); margin-left:auto;">2025</span></h2>

                <div class="total-card">
                    <div class="total-label">–û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞–ª–æ–≥–æ–≤</div>
                    <div class="total-amount" id="totalDisplay">0 ‚ÇΩ</div>
                </div>

                <div style="background:white; border-radius:12px; padding:15px; margin-bottom:20px;">
                    <div class="breakdown-row"><span>–ù–∞–ª–æ–≥ (–†–µ–∂–∏–º)</span><span id="mainTaxDisplay"
                            class="breakdown-value">0</span></div>
                    <div class="breakdown-row"><span>–í–∑–Ω–æ—Å—ã (–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)</span><span id="insEmpDisplay"
                            class="breakdown-value">0</span></div>
                    <div class="breakdown-row" id="rowInsIp" style="display:none"><span>–í–∑–Ω–æ—Å—ã (–ò–ü)</span><span
                            id="insIpDisplay" class="breakdown-value">0</span></div>
                    <div class="breakdown-row" id="rowVat" style="display:none"><span>–ù–î–°</span><span id="vatDisplay"
                            class="breakdown-value">0</span></div>
                    <div class="breakdown-row" id="rowAssets" style="display:none"><span>–ò–º—É—â–µ—Å—Ç–≤–æ/–ó–µ–º–ª—è</span><span
                            id="assetsDisplay" class="breakdown-value">0</span></div>
                    <div class="breakdown-row" id="rowDiv"
                        style="display:none; color:var(--text-light); border-top:1px dashed #e5e7eb; margin-top:5px; padding-top:10px;">
                        <span>+ –î–∏–≤/–í—ã–≤–æ–¥ (<span id="divRateDisplay">13</span>%)</span><span id="divTaxDisplay"
                            class="breakdown-value">0</span>
                    </div>
                </div>

                <h3 style="font-size:0.9rem; font-weight:700; margin-bottom:10px; color:var(--text-light);">–°–†–ê–í–ù–ï–ù–ò–ï
                    –†–ï–ñ–ò–ú–û–í</h3>
                <div style="overflow-x:auto;">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>–†–µ–∂–∏–º</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞–≤–∫–∞</th>
                                <th>–ò–Ω—Ñ–æ</th>
                            </tr>
                        </thead>
                        <tbody id="compBody"></tbody>
                    </table>
                </div>

                <div class="insight-info" id="insightBox"></div>
            </div>
        </div>
    </div>

    <script>
        const FORMATTER = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 });
        const parse = val => parseFloat(val?.replace(/[^0-9.]/g, '')) || 0;

        const CONFIG = {
            2025: { vat_rate: 0.20, usn_vat_threshold: 60000000, it_ins_rate: 0.076, insurance_cap: 2760000 },
            2026: { vat_rate: 0.22, usn_vat_threshold: 10000000, it_ins_rate: 0.15, insurance_cap: 3000000 },
            common: { usn6: 0.06, usn15: 0.15, eshn: 0.06, profit: 0.25, mw: 22440, ip_fixed: 53658, usn_hard_limit: 450000000 }
        };

        const STATE = {
            year: 2025, entity: 'ip', regime: 'usn_income',
            income: 15000000, expenses: 8000000, employees: 3, avgSalary: 70000, tradeLevy: 0,
            propertyValue: 0, landValue: 0,
            isSme: true, isNewIp: false, isPartnership: false,
            region: 'moscow', type: 'services', usnVatMode: 'special'
        };

        const LOGIC = {
            calcInsurance(s, cfg) {
                if (s.employees <= 0) return 0;
                const totalSal = s.avgSalary * 12;
                if (s.type === 'it') return totalSal * cfg.it_ins_rate * s.employees;
                const isPriority = (s.type === 'production' || s.type === 'science');
                if (isPriority) return totalSal * 0.076 * s.employees;

                let applySme = s.isSme;

                if (s.year === 2026 && !isPriority) applySme = false;

                if (applySme) {
                    const base = Math.min(s.avgSalary, CONFIG.common.mw);
                    const excess = Math.max(0, s.avgSalary - CONFIG.common.mw);
                    return ((base * 0.3) + (excess * 0.15)) * 12 * s.employees;
                } else {
                    if (totalSal <= cfg.insurance_cap) return totalSal * 0.3 * s.employees;
                    return ((cfg.insurance_cap * 0.3) + ((totalSal - cfg.insurance_cap) * 0.151)) * s.employees;
                }
            },

            calc(s) {
                const cfg = CONFIG[s.year];
                const res = {};

                const insEmp = this.calcInsurance(s, cfg);
                const insIp = s.entity === 'ip' ? (CONFIG.common.ip_fixed + Math.max(0, (s.income - 300000) * 0.01)) : 0;
                const totalIns = insEmp + insIp;
                const usnStrictLimit = (s.income > CONFIG.common.usn_hard_limit);
                let usnVat = 0;

                if (!usnStrictLimit && s.income > cfg.usn_vat_threshold) {
                    if (s.usnVatMode === 'special') {
                        const rate = s.income > 250000000 ? 0.07 : 0.05;
                        usnVat = s.income * rate;
                    } else {
                        const netInc = s.income / (1 + cfg.vat_rate);
                        const netExp = s.expenses / (1 + cfg.vat_rate);
                        usnVat = Math.max(0, (s.income - netInc) - (s.expenses - netExp));
                    }
                }

                const isHoliday = (s.entity === 'ip' && s.isNewIp && (s.type === 'production' || s.type === 'science'));

                // 1. USN 6
                if (usnStrictLimit) res.usn_income = { error: '–°–ª–µ—Ç (>450–º–ª–Ω)' };
                else if (s.isPartnership) res.usn_income = { error: '–ó–∞–ø—Ä–µ—â–µ–Ω–æ (–¢–æ–≤–∞—Ä–∏—â–µ—Å—Ç–≤–æ)' };
                else {
                    let rate6 = isHoliday ? 0 : 0.06;
                    let tax6 = s.income * rate6;
                    let maxInsDed = (s.entity === 'ip' && s.employees === 0) ? tax6 : tax6 * 0.5;
                    let dedIns = Math.min(totalIns, maxInsDed);
                    let taxAfterIns = tax6 - dedIns;
                    let dedLevy = Math.min(taxAfterIns, s.tradeLevy);
                    let finalTax = taxAfterIns - dedLevy;
                    let badges = [];
                    if (isHoliday) badges.push('0% –ö–∞–Ω–∏–∫—É–ª—ã');
                    if (dedLevy > 0) badges.push('–í—ã—á–µ—Ç –¢–æ—Ä–≥.–°–±–æ—Ä–∞');

                    res.usn_income = { main: finalTax, ins: totalIns, vat: usnVat, badges: badges };
                    res.usn_income.total = finalTax + totalIns + usnVat + s.tradeLevy;
                }

                // 2. USN 15
                if (usnStrictLimit) {
                    res.usn_income_expenses = { error: '–°–ª–µ—Ç (>450–º–ª–Ω)' };
                } else {
                    let rate15 = 0.15;
                    let tags15 = [];
                    if (s.region === 'moscow' && (s.type === 'production' || s.type === 'science')) { rate15 = 0.10; tags15.push('–ú–æ—Å–∫–≤–∞ 10%'); }
                    if (isHoliday) { rate15 = 0; tags15 = ['0% –ö–∞–Ω–∏–∫—É–ª—ã']; }
                    let totalExp = s.expenses + s.tradeLevy;
                    let base15 = Math.max(0, s.income - totalExp - totalIns);
                    let tax15 = base15 * rate15;
                    let minTax = isHoliday ? 0 : s.income * 0.01;
                    if (!isHoliday && tax15 < minTax) { tax15 = minTax; tags15.push('–ú–∏–Ω. –Ω–∞–ª–æ–≥ 1%'); }

                    res.usn_income_expenses = { main: tax15, ins: totalIns, vat: usnVat, badges: tags15 };
                    res.usn_income_expenses.total = tax15 + totalIns + usnVat + s.tradeLevy;
                }

                // 3. OSNO
                let osnoExp = s.expenses + s.tradeLevy;
                const netInc = s.income / (1 + cfg.vat_rate);
                const netExp = osnoExp / (1 + cfg.vat_rate);
                const vatRes = Math.max(0, (s.income - netInc) - (s.expenses - netExp));
                const profitBase = Math.max(0, netInc - netExp - totalIns);

                let taxes = { main: 0, ins: totalIns, vat: vatRes, div: 0, badges: [] };

                if (s.entity === 'ip') {
                    taxes.main = profitBase * 0.15; // Simplified PIT
                } else {
                    // OOO
                    let profitRate = CONFIG.common.profit; // Default 25%
                    if (s.type === 'it') {
                        profitRate = 0.05; // IT Benefit 5%
                        taxes.badges.push('–õ—å–≥–æ—Ç–∞ IT 5%');
                    }

                    taxes.main = profitBase * profitRate;
                    let netProfit = profitBase - taxes.main;
                    // Dividends
                    if (netProfit > 0) {
                        let divRate = 0.13;
                        taxes.div = netProfit * divRate;
                        taxes.divRate = divRate;
                    }
                }

                res.osno = taxes;
                res.osno.total = taxes.main + totalIns + vatRes + (taxes.div || 0) + s.tradeLevy;

                // 4. Patent
                if (s.entity === 'ip' && s.income < 60000000) {
                    let cost = 1000000 * 0.06;
                    if (isHoliday) cost = 0;
                    let ded = isHoliday ? 0 : Math.min(totalIns, s.employees === 0 ? cost : cost * 0.5);
                    res.patent = { main: cost - ded, ins: totalIns, vat: 0, badges: isHoliday ? ['0% –ö–∞–Ω–∏–∫—É–ª—ã'] : [] };
                    res.patent.total = (cost - ded) + totalIns + s.tradeLevy;
                } else { res.patent = { error: '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω (<60–º–ª–Ω)' }; }

                // 5. ESHN
                {
                    res.eshn = { main: Math.max(0, s.income - s.expenses - totalIns) * 0.06, ins: totalIns, vat: 0, badges: [] };
                    res.eshn.total = res.eshn.main + totalIns;
                }

                // Asset Taxes
                const landTax = s.landValue * 0.015; // 1.5% Land Tax (All regimes)
                // Property Tax (2.2%) - OSNO pays on everything. USN pays ONLY on Cadastral (we assume input IS cadastral for simplicity to show worst case or user intent)
                // Actually, USN is exempt from "Book Value" property but pays on "Cadastral".
                // We'll apply it for OSNO fully. For USN, we'll assume the user entered "Taxable Property" value.
                // To be precise: OSNO = 2.2% default. USN = 2% (often lower regional rate for cadastral). Let's use 2.2% OSNO and 2% USN for Cadastral.
                const propTaxOsno = s.propertyValue * 0.022;
                const propTaxUsn = s.propertyValue * 0.02; // Approx for Cadastral office/retail

                // Add to each regime
                if (res.usn_income) { res.usn_income.assets = landTax + propTaxUsn; res.usn_income.total += res.usn_income.assets; }
                if (res.usn_income_expenses) { res.usn_income_expenses.assets = landTax + propTaxUsn; res.usn_income_expenses.total += res.usn_income_expenses.assets; }
                if (res.osno) { res.osno.assets = landTax + propTaxOsno; res.osno.total += res.osno.assets; }
                if (res.patent && !res.patent.error) { res.patent.assets = landTax; /* Patent IP exempt from propery tax used in business, except cadastral list */ res.patent.total += res.patent.assets; }
                if (res.eshn && !res.eshn.error) { res.eshn.assets = landTax + propTaxUsn; res.eshn.total += res.eshn.assets; }

                return res;
            }
        };

        const UI = {
            setYear(y) {
                STATE.year = y;
                document.getElementById('year2025').className = `year-btn ${y === 2025 ? 'active' : ''}`;
                document.getElementById('year2026').className = `year-btn ${y === 2026 ? 'active' : ''}`;
                document.getElementById('resYearDisplay').innerText = y;
                this.update();
            },
            setEntityType(t) {
                STATE.entity = t;
                document.getElementById('typeIP').className = `entity-toggle ${t === 'ip' ? 'active' : ''}`;
                document.getElementById('typeOOO').className = `entity-toggle ${t === 'ooo' ? 'active' : ''}`;
                document.getElementById('typeOOO').className = `entity-toggle ${t === 'ooo' ? 'active' : ''}`;

                const pat = document.getElementById('optPatent');
                const eshn = document.getElementById('optEshn');
                const usn6 = document.getElementById('optUsn6');
                const usn15 = document.getElementById('optUsn15');

                if (t === 'ip') {
                    pat.classList.remove('disabled');
                    eshn.classList.remove('disabled');
                    usn6.classList.remove('disabled');
                    usn15.classList.remove('disabled');
                    document.getElementById('ipNewBox').style.display = 'flex';
                    document.getElementById('partnershipBox').style.display = 'flex';
                } else if (t === 'ooo') {
                    pat.classList.add('disabled');
                    eshn.classList.remove('disabled');
                    usn6.classList.remove('disabled');
                    usn15.classList.remove('disabled');
                    document.getElementById('ipNewBox').style.display = 'none';
                    document.getElementById('partnershipBox').style.display = 'flex';
                }

                this.update();
            },
            update() {
                // Read
                STATE.income = parse(document.getElementById('annualIncome').value);
                STATE.expenses = parse(document.getElementById('annualExpenses').value);
                STATE.employees = parseInt(document.getElementById('employees').value);
                STATE.avgSalary = parse(document.getElementById('avgSalary').value);
                STATE.tradeLevy = parse(document.getElementById('tradeLevy').value);
                STATE.propertyValue = parse(document.getElementById('propertyValue').value);
                STATE.landValue = parse(document.getElementById('landValue').value);

                STATE.isSme = document.getElementById('isSme').checked;
                STATE.isNewIp = document.getElementById('isNewIp').checked;
                STATE.isPartnership = document.getElementById('isPartnership').checked;
                STATE.region = document.getElementById('region').value;
                STATE.type = document.getElementById('businessType').value;
                STATE.usnVatMode = document.querySelector('input[name="usnVatType"]:checked').value;

                // Trade Levy (Retail + Capitals)
                const isRetail = STATE.type === 'retail';
                const isCapitals = STATE.region === 'moscow' || STATE.region === 'spb';
                document.getElementById('tradeLevyArg').style.display = (isRetail && isCapitals) ? 'block' : 'none';
                if (!(isRetail && isCapitals)) STATE.tradeLevy = 0;

                // Startup Cost
                const costBadge = document.getElementById('startupCostDisplay');
                if (STATE.entity === 'ip') costBadge.innerText = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: 800 ‚ÇΩ (–ì–æ—Å–ø–æ—à–ª–∏–Ω–∞)';
                else costBadge.innerText = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: 4 000 ‚ÇΩ (–ì–æ—Å–ø–æ—à–ª–∏–Ω–∞)';

                // Regime Handling
                document.querySelectorAll('.regime-option').forEach(r => {
                    if (r.classList.contains('active')) STATE.regime = r.dataset.regime;
                    r.onclick = () => {
                        if (r.classList.contains('disabled')) return;
                        document.querySelectorAll('.regime-option').forEach(x => x.classList.remove('active'));
                        r.classList.add('active');
                        this.update();
                    }
                });

                const cfg = CONFIG[STATE.year];
                const limitBroken = STATE.income > CONFIG.common.usn_hard_limit;

                const opt6 = document.getElementById('optUsn6');
                const opt15 = document.getElementById('optUsn15');

                if (STATE.entity !== 'rep') {
                    if (limitBroken) {
                        opt6.classList.add('error');
                        if (opt6.classList.contains('active')) this.setRegime('osno');
                    } else if (STATE.isPartnership) {
                        opt6.classList.add('disabled');
                        if (opt6.classList.contains('active')) {
                            document.getElementById('optUsn15').click();
                            STATE.regime = 'usn_income_expenses';
                        }
                    } else {
                        opt6.classList.remove('error'); opt6.classList.remove('disabled');
                    }
                    if (limitBroken) opt15.classList.add('error'); else opt15.classList.remove('error');
                }

                // USN Warning
                const usnBox = document.getElementById('usnVatBox');
                if (!limitBroken && STATE.income > cfg.usn_vat_threshold && STATE.regime.includes('usn')) {
                    usnBox.style.display = 'block';
                    document.getElementById('usnVatThresholdDisplay').innerText = (cfg.usn_vat_threshold / 1000000).toFixed(0);
                } else usnBox.style.display = 'none';

                // SME NOTE
                const smeNote = document.getElementById('smeBenefitNote');
                const isPriority = (STATE.type === 'production' || STATE.type === 'science');
                if (STATE.year === 2026 && STATE.isSme && !isPriority && STATE.type !== 'it') {
                    smeNote.innerText = "–õ—å–≥–æ—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ (2026)"; smeNote.style.color = 'var(--danger)';
                } else if (STATE.isSme && STATE.entity !== 'rep') { smeNote.innerText = "–õ—å–≥–æ—Ç–∞ 15% –∞–∫—Ç–∏–≤–Ω–∞"; smeNote.style.color = 'var(--success)'; }
                else smeNote.innerText = "";

                const res = LOGIC.calc(STATE);
                const activeRes = res[STATE.regime];

                // Render Results
                document.getElementById('totalDisplay').innerText = activeRes.error ? "‚Äî" : FORMATTER.format(activeRes.total);
                document.getElementById('mainTaxDisplay').innerText = activeRes.error ? "‚Äî" : FORMATTER.format(activeRes.main);

                // Dividends
                const rowDiv = document.getElementById('rowDiv');
                if (activeRes.div > 0) {
                    rowDiv.style.display = 'flex';
                    const divRate = (activeRes.divRate * 100).toFixed(0);
                    document.getElementById('divRateDisplay').innerText = divRate;
                    document.getElementById('divTaxDisplay').innerText = FORMATTER.format(activeRes.div);
                } else rowDiv.style.display = 'none';

                const ipFixed = STATE.entity === 'ip' ? (53658 + Math.max(0, (STATE.income - 300000) * 0.01)) : 0;
                const empIns = activeRes.ins - ipFixed;
                const rowIp = document.getElementById('rowInsIp');
                if (STATE.entity === 'ip') {
                    rowIp.style.display = 'flex';
                    document.getElementById('insIpDisplay').innerText = FORMATTER.format(ipFixed);
                    document.getElementById('insEmpDisplay').innerText = FORMATTER.format(empIns);
                } else {
                    rowIp.style.display = 'none';
                    document.getElementById('insEmpDisplay').innerText = FORMATTER.format(activeRes.ins || 0);
                }

                const rowVat = document.getElementById('rowVat');
                if (activeRes.vat > 0) {
                    rowVat.style.display = 'flex';
                    document.getElementById('vatDisplay').innerText = FORMATTER.format(activeRes.vat);
                } else rowVat.style.display = 'none';

                const rowAssets = document.getElementById('rowAssets');
                if (activeRes.assets > 0) {
                    rowAssets.style.display = 'flex';
                    document.getElementById('assetsDisplay').innerText = FORMATTER.format(activeRes.assets);
                } else rowAssets.style.display = 'none';

                // Table
                const tbody = document.getElementById('compBody');
                tbody.innerHTML = '';
                let min = Infinity;
                Object.values(res).forEach(v => { if (!v.error && v.total < min) min = v.total; });

                const names = { usn_income: '–£–°–ù 6%', usn_income_expenses: '–£–°–ù 15%', osno: '–û–°–ù–û', patent: '–ü–∞—Ç–µ–Ω—Ç', eshn: '–ï–°–•–ù' };
                Object.entries(res).forEach(([k, v]) => {
                    const tr = document.createElement('tr');
                    const isBest = !v.error && v.total === min;
                    if (isBest) tr.classList.add('row-best');
                    let badgesStr = (v.badges || []).map(b => `<span class="badge ${b.includes('0%') || b.includes('–í—ã—á–µ—Ç') ? 'badge-purple' : 'badge-danger'}">${b}</span>`).join(' ');
                    if (isBest) badgesStr += ` <span class="badge badge-success">–í—ã–≥–æ–¥–Ω–æ</span>`;

                    tr.innerHTML = `
                        <td>${names[k]}</td>
                        <td style="font-weight:600">${v.error ? '<span style="color:var(--danger)">' + v.error + '</span>' : FORMATTER.format(v.total)}</td>
                        <td>${v.error ? '' : ((v.total / STATE.income) * 100).toFixed(1) + '%'}</td>
                        <td style="font-size:0.75rem">${badgesStr}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Insights
                const insight = document.getElementById('insightBox');
                let inHtml = "";
                let hasContent = false;

                if (STATE.income > CONFIG.common.usn_hard_limit && STATE.regime.includes('usn')) {
                    inHtml = `<div class="insight-header">‚ö†Ô∏è –ü—Ä–∞–≤–æ –Ω–∞ –£–°–ù —É—Ç—Ä–∞—á–µ–Ω–æ (—Å—Ç. 346.13)</div>
                    <div class="insight-text">–í–∞—à –¥–æ—Ö–æ–¥ –ø—Ä–µ–≤—ã—Å–∏–ª 450 –º–ª–Ω —Ä—É–±.</div>`;
                    hasContent = true;
                } else if (STATE.regime.includes('usn')) {
                    // Logic to see if we have actual insights
                    let listItems = "";
                    if (STATE.isPartnership) listItems += `<li><b>–¢–æ–≤–∞—Ä–∏—â–µ—Å—Ç–≤–æ:</b> –†–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç "–î–æ—Ö–æ–¥—ã - –†–∞—Å—Ö–æ–¥—ã" (—Å—Ç. 346.14).</li>`;
                    if (STATE.type === 'retail' && (STATE.region === 'moscow' || STATE.region === 'spb') && STATE.tradeLevy > 0) {
                        listItems += `<li><b>–¢–æ—Ä–≥–æ–≤—ã–π —Å–±–æ—Ä:</b> –£–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞–ª–æ–≥ (–ø—Ä–∏ –£–°–ù 6%) –∏–ª–∏ —Ä–∞—Å—Ö–æ–¥ (–£–°–ù 15%).</li>`;
                    }

                    if (listItems) {
                        inHtml = `<div class="insight-header">üí° –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã</div>
                        <div class="insight-text"><ul>${listItems}</ul></div>`;
                        hasContent = true;
                    }
                }

                insight.innerHTML = inHtml;
                insight.style.display = hasContent ? 'block' : 'none';
            },
            setRegime(r) {
                document.querySelectorAll('.regime-option').forEach(x => x.classList.remove('active'));
                document.querySelector(`[data-regime="${r}"]`).classList.add('active');
                STATE.regime = r;
                this.update();
            }
        };

        // Init
        document.querySelectorAll('input[type="text"]').forEach(input => {
            input.addEventListener('blur', e => e.target.value = FORMATTER.format(parse(e.target.value)));
        });
        window.onload = () => UI.update();
    </script>
</body>

</html>
